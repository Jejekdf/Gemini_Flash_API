<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Final project</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      #chatBox {
        display: flex;
        flex-direction: column;
      }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="flex flex-col w-full max-w-3xl h-[90vh] bg-white shadow-lg rounded-lg">
      <div id="chatBox" class="flex-1 p-4 overflow-y-auto space-y-3"></div>

      <div class="border-t p-3 flex flex-col gap-2">
        <div id="filePreview" class="flex flex-wrap gap-2"></div>

        <div class="flex gap-2">
          <input type="file" id="fileInput" multiple class="hidden" />
          <button
            onclick="document.getElementById('fileInput').click()"
            class="px-3 py-2 bg-gray-200 rounded-lg"
          >
            <i class="fa-solid fa-plus"></i>
          </button>
          <input
            id="userInput"
            type="text"
            placeholder="Ketik pesan..."
            class="flex-1 border rounded-lg px-3 py-2 focus:outline-indigo-500"
          />
          <button
            id="sendBtn"
            class="px-4 py-2 bg-indigo-500 text-white rounded-lg flex items-center gap-1"
          >
            <i class="fa-regular fa-paper-plane"></i> Kirim
          </button>
        </div>
      </div>
    </div>

    <script>
      const chatBox = document.getElementById("chatBox");
      const userInput = document.getElementById("userInput");
      const sendBtn = document.getElementById("sendBtn");
      const fileInput = document.getElementById("fileInput");
      const filePreview = document.getElementById("filePreview");

      marked.setOptions({ breaks: true });

      function addMessage(content, sender = "user") {
        const wrapper = document.createElement("div");
        wrapper.className = `flex ${
          sender === "user" ? "justify-end" : "justify-start"
        }`;

        const msg = document.createElement("div");
        msg.className = `p-2 rounded-lg max-w-[70%] whitespace-pre-wrap 
        ${
          sender === "user"
            ? "bg-indigo-500 text-white"
            : "bg-gray-200 text-gray-800"
        }`;

        if (sender === "bot") {
          msg.innerHTML = marked.parse(content);
        } else {
          msg.innerHTML = content;
        }

        wrapper.appendChild(msg);
        chatBox.appendChild(wrapper);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      fileInput.addEventListener("change", () => {
        filePreview.innerHTML = "";

        [...fileInput.files].forEach((file, idx) => {
          const previewItem = document.createElement("div");
          previewItem.className =
            "relative w-20 h-20 border rounded-lg overflow-hidden flex items-center justify-center bg-gray-100";

          if (file.type.startsWith("image/")) {
            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.className = "object-cover w-full h-full";
            previewItem.appendChild(img);
          } else if (file.type.startsWith("audio/")) {
            previewItem.innerHTML = `<audio controls src="${URL.createObjectURL(
              file
            )}" class="w-full h-full"></audio>`;
          } else {
            previewItem.innerHTML = `<span class="text-xs text-gray-600 p-1 text-center">
              <i class="fa-solid fa-paperclip"></i> ${file.name}</span>`;
          }

          const removeBtn = document.createElement("button");
          removeBtn.innerHTML = `<i class="fa-solid fa-xmark text-red-500"></i>`;
          removeBtn.className =
            "w-3 h-3 flex items-center justify-center absolute top-1 right-1 bg-white rounded-full shadow hover:bg-gray-100 cursor-pointer";

          removeBtn.onclick = () => {
            const dt = new DataTransfer();
            [...fileInput.files]
              .filter((_, i) => i !== idx)
              .forEach((f) => dt.items.add(f));
            fileInput.files = dt.files;
            previewItem.remove();
          };

          previewItem.appendChild(removeBtn);
          filePreview.appendChild(previewItem);
        });
      });

      async function sendMessage() {
        const text = userInput.value.trim();
        const files = fileInput.files;
        if (!text && files.length === 0) return;

        if (text) addMessage(text, "user");
        if (files.length > 0) {
          [...files].forEach((file) => {
            if (file.type.startsWith("image/")) {
              addMessage(
                `<div><img src="${URL.createObjectURL(file)}" 
              class="max-w-[150px] rounded mb-1"><div class="text-xs opacity-80"><i class="fa-solid fa-image"></i> ${
                file.name
              }</div></div>`,
                "user"
              );
            } else if (file.type.startsWith("audio/")) {
              addMessage(
                `<div><audio controls src="${URL.createObjectURL(
                  file
                )}"></audio>
              <div class="text-xs opacity-80"><i class="fa-solid fa-music"></i> ${
                file.name
              }</div></div>`,
                "user"
              );
            } else {
              addMessage(
                `<i class="fa-solid fa-paperclip"></i> ${file.name}`,
                "user"
              );
            }
          });
        }

        const formData = new FormData();
        formData.append("message", text);
        [...files].forEach((f) => formData.append("files", f));

        userInput.value = "";
        fileInput.value = "";
        filePreview.innerHTML = "";

        try {
          const res = await fetch("/chat", { method: "POST", body: formData });
          const data = await res.json();
          addMessage(data.reply || "⚠️ Error: " + data.error, "bot");
        } catch (e) {
          addMessage("⚠️ " + e.message, "bot");
        }
      }

      sendBtn.addEventListener("click", sendMessage);
      userInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });
    </script>
  </body>
</html>
